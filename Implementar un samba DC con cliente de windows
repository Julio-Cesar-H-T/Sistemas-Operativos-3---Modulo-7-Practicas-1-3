1. Preparación del sistema
--------------------------
hostnamectl set-hostname SO3.inet (NO PUEDES TENER EL MISMO HOSTNAME QUE EL DOMINIO O DARÁ ERROR)
echo "10.0.0.24 SO3.inet" >> /etc/hosts   # poner la IP de su server

#Verificar si se cambió el hostname#
hostname
hostname -f

#Poner al día el sistema e instalar paquetes necesarios#
dnf -y update
dnf -y install epel-release
sudo dnf config-manager --set-enabled powertools
dnf update
sudo dnf makecache
dnf -y install wget tar gcc make python3-devel

2. Descarga e instalación de Samba
----------------------------------
mkdir -p /samba && cd /samba
wget https://download.samba.org/pub/samba/stable/samba-4.16.2.tar.gz
tar -zxvf samba-4.16.2.tar.gz && cd samba-4.16.2/

sudo dnf -y install \
  docbook-style-xsl python3-markdown bison dbus-devel flex gdb \
  gnutls-devel jansson-devel keyutils-libs-devel krb5-workstation \
  libacl-devel libaio-devel libarchive-devel libattr-devel libblkid-devel \
  libtasn1 libtasn1-tools libxml2-devel libxslt lmdb-devel openldap-devel \
  pam-devel perl perl-ExtUtils-MakeMaker perl-Parse-Yapp popt-devel \
  python3-cryptography python3-dns python3-gpg readline-devel rpcgen \
  systemd-devel zlib-devel perl-JSON gpgme-devel screen

./configure --prefix=/usr/local/samba --enable-fhs --with-ads --with-systemd
make -j$(nproc)
make install

Poner este comando primero
export PATH=/usr/local/samba/bin:/usr/local/samba/sbin:$PATH

NOTA: Si te aparece contenido en el primer nano (~/.bash_profile) solo reemplaza el path que tenga ese archivo con el nuevo y listo, el otro archivo (../.bash_profile) no existe.
nano ~/.bash_profile 
        PATH=$PATH:$HOME/bin:/usr/local/samba/bin:/usr/local/samba/sbin:$PATH
        export PATH  


nano ../.bash_profile
        PATH=$PATH:$HOME/bin:/usr/local/samba/bin:/usr/local/samba/sbin:$PATH
        export PATH

NOTA: Asegurate que en --option="interfaces= lo ens160" tenga el verdadero nombre de tu interfaz de red, o sea que en vez de ens160 tenga el nombre de la interfaz que usas (si no sabes, pon ip a en la terminal y el nombre que vas a usar será la interfaz que tenga la ip de tu maquina).
samba-tool domain provision --use-rfc2307 --interactive --option="interfaces= lo ens160" --option="bind interfaces only=yes"

#Dominio: OS3.inet  
#Nombre de dominio: OS3 
#Nombre de controlador: dc  
#Backend DNS: SAMBA_INTERNAL  
#Contraseña: [CONTRASEÑA] Te va a pedir una contraseña de minimo 7 caracteres y que cumpla con los requerimentos de complejidad 

# inicia el servicio de samba con el siguiente comando
samba
NOTA: Si de casualidad se reinicia el sistema, no va a iniciar samba con ese comando, así que tendrás que usar "sudo /usr/local/samba/sbin/samba" para ejecutarlo, que es su ruta absoluta.

#Pruebas de DNS
ping google.com
ping OS3.inet
ping dc1.inet (si no funciona el OS3.inet en Linux, prueba tu hostname, pero debe funcionar como OS3.inet en Windows) 

#Copiar el Archivo de Kerberos
cp /usr/local/samba/var/lib/samba/private/krb5.conf /etc/krb5.conf

#Agregar reglas al firewall
firewall-cmd --permanent --add-service={ldap,ldaps,kerberos,dns}
firewall-cmd --permanent --add-port={53,88,135,139,389,445,464,636,3268,3269}/tcp
firewall-cmd --permanent --add-port={53,88,123,138,389,464}/udp
firewall-cmd --reload

# Configura el DNS para que sea solo la IP del propio servidor
sudo nmcli con mod ens160 ipv4.dns 10.0.0.24

# Le dice que ignore cualquier DNS automático (como el de DHCP)
sudo nmcli con mod ens160 ipv4.ignore-auto-dns yes

# Aplica los cambios
sudo nmcli con up ens160

NOTA: Necesitas cambiarle el DNS a tu maquina SERVER para que las CLIENTE que estén en el dominio puedan acceder a internet 

# Agregar Registro DN maquina cliente
###################IP DEl SERVER ################ IP VM WINDOWS ################                
samba-tool dns add 10.0.0.24 OS3.inet www A 10.0.0.25 -U Administrator

Agregar Usuario al Dominio
sudo /usr/local/samba/bin/samba-tool user create lanegracubana "Julio20250702" --given-name="La Negra" --surname="Cubana" --mail=lanegracubana@so3.inet

#### en la VM de windows###:

## En la configuracion de al tarjeta de Red cambiar el DNS de la maquina a que apunte al servidor de Linux ##
Presione Win + R y escriba ncpa.cpl, luego le da click derecho al adaptador de red, propiedades y seleccione "Protocolo de Internet versión 4 (TCP/IPv4)" y propiedades.
Dejas la IP como esté y cambias el DNS a manual, y en servidor dns preferido pones la ip de tu SERVER y en servidor alternativo lo dejas vacío o va a fallar.
Luego abres CMD y escribes: ipconfig /flushdns

#haga ping al dominio (OS3.inet) el ping debe de responder con al Ip del servidor
ping OS3.inet
ping www.OS3.inet

Presiona Win + R, escribe sysdm.cpl y presiona Enter.
Ir a "Nombre del equipo" > "Cambiar":

Selecciona Miembro de un dominio e ingresa: os3.inet
Le va a pedir un reinicio en la maquina de windows, y luego de eso, le das a other users y pones:

Usuario: OS3\Administrator (NOTA: Si pones solo Administrator, windows lo va a tomar como un usuario local y te va a decir contraseña incorrecta aunque esté bien)
Contraseña: [Contraseña puesta]



#########################################################################################################################
#########################################################################################################################
Troubleshooting:


[root@OS3 samba-4.16.2]# samba-tool domain provision --use-rfc2307 --interactive --option="interfaces= lo ens160" --option="bind interfaces only=yes"
Realm [INET]: 
Domain [INET]: OS3 
Server Role (dc, member, standalone) [dc]:
 DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]: 
DNS forwarder IP address (write 'none' to disable forwarding) [8.8.8.8]: 
Administrator password: 
Retype password: 
ERROR(<class 'samba.provision.ProvisioningError'>): Provision failed - ProvisioningError: guess_names: Domain 'OS3' must not be equal to short host name 'OS3'!

Solución: Esto significa que el hostname del server no puede ser igual al nombre del dominio, necesitas cambiar cambiar el nombre (hostnamectl y luego lo del archivo /etc/hosts), borrar el archivo que creó esa configuración erronea (si lo haces sin eliminar no va a funcionar y te va a dar instrucciones de como eliminarlo) y correr otra vez el comando de domain provision.


Si se te olvidó la contraseña, pon (EN EL SERVER): 

samba-tool user setpassword [USUARIO]


Si sigue sin funcionar el inicio de sesión pero todo está correcto, revisa el firewall y el estado de SELinux:

# Rango estándar de puertos dinámicos para RPC
sudo firewall-cmd --permanent --add-port=49152-65535/tcp

# Recarga el firewall para aplicar los cambios
sudo firewall-cmd --reload

# Pone SELinux en modo permisivo temporalmente
sudo setenforce 0

# Para verificar el estado (debería decir "Permissive")
sestatus

# Desactivar el Firewall de windows por si acaso
Set-NetFirewallProfile -Profile Domain,Private,Public -Enabled False
